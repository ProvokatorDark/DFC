# Dangerous Functions Checker


# Алгоритм поиска вирусов

* Выкачать сайт локально

	`./0_lftp.sh`

* Первым делом найти одинаковые файлы: как правило, это шеллы. Найденные файлы будут скопированы в каталог virii и удалены. Список найденного можно посмотреть в detections/duplicate.txt.

	`find www/ -name "*.php" > phps.txt`
	`php -f 1_find_duplicates.php phps.txt`

* Теперь поищем файлы с большими блоками закодированного в base64 текста без пробелов: как правило, это шеллы. Строки с кодированием вырежем, если файлы после этого становятся пустыми, удалим их. Список найденного можно посмотреть в detections/base64_blocks.txt.

	`find www/ -name "*.php" > phps.txt`
	`php -f 2_find_base64_blocks.php phps.txt`

* Теперь поищем однострочные вирусы.

	`find www/ -name "*.php" > phps.txt`
	`php -f 3_find_oneliners.php phps.txt`

* Теперь поищем инъекции однострочников в начало файлов и вырежем их. Список найденного можно посмотреть в detections/head_injects.txt.

	`find www/ -name "*.php" > phps.txt`
	`php -f 4_find_head_injects.php phps.txt`


* Проверить сайт этим скриптом. Результаты проверки будут в каталоге detected. Эти файлы проверяем вручную, названия подозрительных вручную заносим в файл suspected.txt (один файл на строку)

	`php -f 5_scan.php www`

* Поиск php-кода в файлов с расширениями не .php:

	`./6_php_in_nophp.sh www > php_in_nophp.txt`

* Также есть скрипт для вытаскивания из отчёта айболита  (https://revisium.com/ai/) файлов, которые он в чём-то заподозрил. Лучше визуально проверить, все ли файлы он нашёл и не нашёл ли лишнего (скрипт пока не идеален). Найденные файлы добавляем в suspected.txt.

	`php -f parse_aibolit_report.php aibolit_report.html`

* Делаем резервную копию файлов, отмеченных как подозрительные, в каталог virii

	`php -f 7_backup_virii.php suspected.txt`

* Вручную просматриваем каждый файл из подозрительных, вирусы удаляем, файлы сохраняем

	`./8_view.sh suspected.txt`

* Проводим анализ сделанных нами изменений по сравнению с каталогом virii. Если файл изменён, оставляем его копию в каталоге virii и записываем его название в файл files_repl.txt. Если размер файла - 0 или 1 (т. е. его содержимое удалено), то удаляем этот файл, его копию оставляем в каталоге virii и записываем его название в файл files_del.txt. Если файл идентичен своей копии, лежащей в virii, т. е. файл не изменился, значит, файл не заражён, удаляем его копию из каталога virii.

	`php -f 9_diff_virii.php suspected.txt`

